<!--
  ~ Created by Alex Matos Iuasse.
  ~ Copyright (c) 2020.  All rights reserved.
  ~ Last modified 07/09/2020 17:37.
  -->

{% extends './homepage.html' %}
{% load l10n %}
{% load static %}
{% block custom_css %}
<link href="{% static 'custom/css/custom-css.css' %}" rel="stylesheet"/>
<link href="{% static 'dist/libs/fullcalendar/dist/main.min.css' %}" rel="stylesheet"/>
{% endblock %}
{% block header %}{% include './profile_header.html' with header_class='sticky-top bg-dark ' %}{% endblock %}
{% block hero %}{% endblock %}
{% block main %}
<main id="main">
    <section class="calendar" id="calendar">
        <div class="container" data-aos="fade-up">
            <div class="card">
                <div class="card-body">
                    <div id="calendar-services"></div>
                </div>
                <div class="card-footer">
                    <div class="row align-items-center">
                        <h2>Legenda</h2>
                        <div class="col-2 square dayfull ml-3"></div>
                        <div class="col">Lotado</div>
                    </div>
                    <div class="row align-items-center">
                        <div class="col-2 square daynotfull ml-3"></div>
                        <div class="col">Não Lotado</div>
                    </div>
                    <div class="row align-items-center">
                        <div class="col-2 square notworkday ml-3"></div>
                        <div class="col">Não Atendendo</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
{% endblock %}
{% block javascript %}
<script src="{% static 'dist/libs/fullcalendar/dist/main.min.js' %}"></script>
<script src="{% static 'dist/libs/fullcalendar/dist/locales-all.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar-services');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        timeZone: 'UTC',
        themeSystem: 'standart',
        headerToolbar: {
            left: 'today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
        },
        initialView: 'dayGridMonth',
        initialDate: '{{start_date|date:"Y-m-d"}}',
        locale: 'pt-br',
        height: 'auto',
        buttonIcons: true, // show the prev/next text
        weekNumbers: false,
        navLinks: true, // can click day/week names to navigate views
        editable: true, // can drag and change date/time of events
        dayMaxEvents: true, // allow "more" link when too many events
        businessHours: true, // display business hours
        nowIndicator: true,

        // hours to be displayed
        // slotMinTime: '08:00',
        // slotMaxTime: '20:00',

        selectable: true,
        selectMirror: true,

        // Note: Make a modal show with a form, send to server validate and return response
        select: function(arg) {
           // if (!arg.allDay) {
                //$('#id_businessdayform-start').val(arg.start.toISOString().split('T')[0]);
                //$('#id_businessdayform-end').val(arg.end.toISOString().split('T')[0]);
                //$('#modal-form-business').modal('show');
           // }
           calendar.unselect()
        },


        eventDrop: function(eventDropInfo) {
            if (eventDropInfo.event.extendedProps['type'] == 0) {
                $.ajax({
                    url: '{% url 'service:orderofservice:change_date' %}',
                    data: {
                        'pk': eventDropInfo.event.extendedProps['pk'],
                        'date': eventDropInfo.event.start.toISOString().split('T')[0],
                        'time': eventDropInfo.event.start.toISOString().split('T')[1],
                    },
                    dataType: 'json',
                    success: function (data) {
                        if (!data.status) {
                            alert(data.error_message);
                            eventDropInfo.revert();
                        }
                    },
                    error: function (data) {
                        alert("Error: " + data.status + " " + data.statusText);
                        eventDropInfo.revert();
                    }
                });
            } else {
                eventDropInfo.revert();
            }
        },

        /*
        // Called when an event has been clicked
        eventClick: function(arg) {
            if (confirm('Are you sure you want to delete this event?')) {
              arg.event.remove()
            }
        },
        */

        // Fetch the "events" in base of a range date, avoiding huge loads
        events: {
            url: '{% url 'business:calendar:data_frontend' customer=request.user.pk %}',
            success: function(data) {
                return data.data;
            }
        },

    });

    calendar.render();
  });

</script>
{% endblock %}